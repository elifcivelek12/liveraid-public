steps:
  # 1. Adım: Docker imajını oluştur
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Docker Image'
    args:
      - 'build'
      - '-t'
      - '${_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${COMMIT_SHA}'
      - '.'

  # 2. Adım: Docker imajını Artifact Registry'ye yükle
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Docker Image'
    args:
      - 'push'
      - '${_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${COMMIT_SHA}'

  # 3. Adım: Alembic ile veritabanı migration'larını çalıştır
  - name: 'gcr.io/google-appengine/exec-wrapper'
    id: 'Run Alembic Migrations'
    args:
      - '-i'
      - '${_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${COMMIT_SHA}'
      - '-s'
      - '${_CLOUD_SQL_CONNECTION_NAME}'
      # --- DÜZELTME BURADA ---
      # Ortam değişkenlerini shell formatında ($VAR_NAME) aktarıyoruz.
      - '-e'
      - 'DB_USER=$DB_USER'
      - '-e'
      - 'DB_PASS=$DB_PASS'
      - '-e'
      - 'DB_NAME=$DB_NAME'
      - '--'
      - 'alembic'
      - 'upgrade'
      - 'head'
    # Bu adım için ortam değişkeni olarak kullanılacak gizli değerler.
    secretEnv: ['DB_USER', 'DB_PASS', 'DB_NAME']

  # 4. Adım: Uygulamayı Cloud Run'a dağıt
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy to Cloud Run'
    entrypoint: 'gcloud'
    args:
      - 'run'
      - 'deploy'
      - '${_SERVICE_NAME}'
      - '--image'
      - '${_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${COMMIT_SHA}'
      - '--region'
      - '${_LOCATION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--set-secrets'
      - 'DB_USER=${_DB_USER_SECRET_NAME}:latest,DB_PASS=${_DB_PASS_SECRET_NAME}:latest,DB_NAME=${_DB_NAME_SECRET_NAME}:latest,FLASK_SECRET_KEY=${_FLASK_SECRET_KEY_SECRET_NAME}:latest,GOOGLE_AI_API_KEY=${_GOOGLE_AI_API_KEY_SECRET_NAME}:latest,OPENROUTER_API_KEY=${_OPENROUTER_API_KEY_SECRET_NAME}:latest,CLOUD_SQL_CONNECTION_NAME=${_CLOUD_SQL_CONNECTION_NAME_SECRET_NAME}:latest'
      - '--add-cloudsql-instances'
      - '${_CLOUD_SQL_CONNECTION_NAME}'

# Bu build'in ihtiyaç duyduğu gizli değerleri tanımlıyoruz.
# env: 'DB_USER' -> Bu, 'DB_USER' adında bir ortam değişkeni oluşturur.
availableSecrets:
  secretManager:
  - versionName: projects/${PROJECT_ID}/secrets/${_DB_USER_SECRET_NAME}/versions/latest
    env: 'DB_USER'
  - versionName: projects/${PROJECT_ID}/secrets/${_DB_PASS_SECRET_NAME}/versions/latest
    env: 'DB_PASS'
  - versionName: projects/${PROJECT_ID}/secrets/${_DB_NAME_SECRET_NAME}/versions/latest
    env: 'DB_NAME'

# Build sırasında kullanılacak değişkenler.
substitutions:
  _LOCATION: 'europe-west4' 
  _REPOSITORY: 'liveraid-public' 
  _SERVICE_NAME: 'liveraid-service' 
  _CLOUD_SQL_CONNECTION_NAME: 'tactile-vial-468307-d3:europe-west3:liveraid-postgres'
  # --- SECRET ADLARI ---
  _DB_USER_SECRET_NAME: 'DB_USER'
  _DB_PASS_SECRET_NAME: 'DB_PASS'
  _DB_NAME_SECRET_NAME: 'DB_NAME'
  _FLASK_SECRET_KEY_SECRET_NAME: 'FLASK_SECRET_KEY'
  _GOOGLE_AI_API_KEY_SECRET_NAME: 'GOOGLE_AI_API_KEY'
  _OPENROUTER_API_KEY_SECRET_NAME: 'OPENROUTER_API_KEY'
  _CLOUD_SQL_CONNECTION_NAME_SECRET_NAME: 'CLOUD_SQL_CONNECTION_NAME'

images:
  - '${_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY}/${_SERVICE_NAME}:${COMMIT_SHA}'